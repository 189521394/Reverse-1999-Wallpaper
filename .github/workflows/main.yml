name: Sync storybg/story_atcg folder

permissions:
  contents: write

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    
    steps:
      # 1. æ¸…ç†ç©ºé—´
      - name: Free Disk Space (Ubuntu)
        uses: jlumbroso/free-disk-space@v1.3.1
        with:
          tool-cache: true
          android: true
          dotnet: true
          haskell: true
          large-packages: true
          docker-images: true
          swap-storage: false

      # 2. ç­¾å‡ºè‡ªå·± (depth 1)
      - name: Checkout this repository
        uses: actions/checkout@v3
        with:
          lfs: true       
          fetch-depth: 1  

      # 3. å®‰è£… LFS (é€šç”¨)
      - name: Install Git LFS
        run: git lfs install --local

      # 4. ç­¾å‡ºä¸Šæ¸¸ (ä¿®æ­£ç‚¹ï¼šå¢åŠ  lfs: true ä»¥é˜²ä¸‡ä¸€)
      - name: Checkout upstream repo (sparse & shallow)
        uses: actions/checkout@v3
        with:
          repository: myssal/Reverse-1999-CN-Asset
          token: ${{ secrets.GITHUB_TOKEN }}
          path: upstream
          fetch-depth: 1
          lfs: true            # ç¡®ä¿æ‹‰ä¸‹æ¥çš„æ˜¯çœŸå›¾ç‰‡
          persist-credentials: false
          sparse-checkout: |
            singlebg/storybg/story_atcg
            singlebg/storybg/story_bg
            singlebg/storybg/bg
          sparse-checkout-cone-mode: true

      # 5. åŒæ­¥ (æ¸…ç† upstream)
      - name: Sync directories
        run: |
          mkdir -p singlebg/storybg/story_atcg singlebg/storybg/story_bg singlebg/storybg/bg

          rsync -av --delete upstream/singlebg/storybg/story_atcg/ singlebg/storybg/story_atcg/
          rsync -av --delete upstream/singlebg/storybg/story_bg/   singlebg/storybg/story_bg/
          rsync -av --delete upstream/singlebg/storybg/bg/         singlebg/storybg/bg/
          
          rm -rf upstream

      # 6. LFS è¿½è¸ª (ä¿®æ­£ç‚¹ï¼šæ”¹å›åªè¿½è¸ªå›¾ç‰‡ï¼Œæˆ–è€…æ ¹æ®éœ€è¦è°ƒæ•´)
      - name: Track large assets with LFS
        run: |
          # åªè¿½è¸ªpng
          git lfs track "singlebg/storybg/**/*.png"
          
          git add .gitattributes

      # 7. æäº¤
      - name: Configure git and push
        run: |
          git config --global http.postBuffer 524288000
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git status

          # ä¿®æ­£ç‚¹ï¼šæ˜ç¡®æŒ‡å®šæ·»åŠ çš„ç›®å½•ï¼Œé˜²æ­¢æ„å¤–
          git add .gitattributes
          git add singlebg/storybg
          
          if git diff --cached --quiet; then
            echo "âœ… No changes to commit"
          else
            echo "ğŸ“¦ Committing changes..."
            git commit -m "chore: sync story assets from upstream"
            git push
          fi
